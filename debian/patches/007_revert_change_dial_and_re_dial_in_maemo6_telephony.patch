From 72429367b04c5cb822ab1269081ea5642147c8c6 Mon Sep 17 00:00:00 2001
From: Dmitriy Paliy <dmitriy.paliy@nokia.com>
Date: Wed, 16 Mar 2011 15:22:35 +0200
Subject: [PATCH 2/3] Revert "Change dial and re-dial in maemo6 telephony"

This reverts commit fcd1ac9c72f229485342d8105c0ccdd4a0c07aa1.
---
 audio/telephony-maemo6.c |   27 +++++++++++++--------------
 1 files changed, 13 insertions(+), 14 deletions(-)

diff --git a/audio/telephony-maemo6.c b/audio/telephony-maemo6.c
index 311b5ed..04c69c6 100644
--- a/audio/telephony-maemo6.c
+++ b/audio/telephony-maemo6.c
@@ -579,19 +579,14 @@ static int send_method_call(const char *dest, const char *path,
 
 void telephony_last_dialed_number_req(void *telephony_device)
 {
-	int ret;
-
 	DBG("telephony-maemo6: last dialed number request");
 
-	ret = send_method_call(CSD_CALL_BUS_NAME, CSD_CALL_PATH,
-				CSD_CALL_INTERFACE, "CreateFromLast",
-				NULL, NULL,
-				DBUS_TYPE_INVALID);
-	if (ret < 0)
-		telephony_dial_number_rsp(telephony_device,
-						CME_ERROR_AG_FAILURE);
+	if (last_dialed_number)
+		telephony_dial_number_req(telephony_device,
+						last_dialed_number);
 	else
-		telephony_dial_number_rsp(telephony_device, CME_ERROR_NONE);
+		telephony_last_dialed_number_rsp(telephony_device,
+						CME_ERROR_NOT_ALLOWED);
 }
 
 static const char *memory_dial_lookup(int location)
@@ -604,15 +599,18 @@ static const char *memory_dial_lookup(int location)
 
 void telephony_dial_number_req(void *telephony_device, const char *number)
 {
+	uint32_t flags = callerid;
 	int ret;
 
 	DBG("telephony-maemo6: dial request to %s", number);
 
-	if (strncmp(number, "*31#", 4) == 0)
+	if (strncmp(number, "*31#", 4) == 0) {
 		number += 4;
-	else if (strncmp(number, "#31#", 4) == 0)
+		flags = CALL_FLAG_PRESENTATION_ALLOWED;
+	} else if (strncmp(number, "#31#", 4) == 0) {
 		number += 4;
-	else if (number[0] == '>') {
+		flags = CALL_FLAG_PRESENTATION_RESTRICTED;
+	} else if (number[0] == '>') {
 		const char *location = &number[1];
 
 		number = memory_dial_lookup(strtol(&number[1], NULL, 0));
@@ -625,9 +623,10 @@ void telephony_dial_number_req(void *telephony_device, const char *number)
 	}
 
 	ret = send_method_call(CSD_CALL_BUS_NAME, CSD_CALL_PATH,
-				CSD_CALL_INTERFACE, "Create",
+				CSD_CALL_INTERFACE, "CreateWith",
 				NULL, NULL,
 				DBUS_TYPE_STRING, &number,
+				DBUS_TYPE_UINT32, &flags,
 				DBUS_TYPE_INVALID);
 	if (ret < 0) {
 		telephony_dial_number_rsp(telephony_device,
-- 
1.7.1

